<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NiiVue Viewer – GT vs Prediction (Per-layer Labels 1/2/3)</title>
  <style>
    html, body { margin: 0; height: 100%; background: #000; overflow: hidden; }
    #toolbar {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(0,0,0,0.72); color: #fff; font-family: system-ui, sans-serif; font-size: 14px;
      padding: 12px; border-radius: 12px; min-width: 320px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }
    #toolbar h3 { margin: 0 0 8px; font-size: 15px; }
    #toolbar label { display: block; margin: 6px 0; cursor: pointer; }
    #toolbar hr { border: none; border-top: 1px solid rgba(255,255,255,0.12); margin: 10px 0; }
    .hint { color: #bbb; font-size: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 16px; }
    .section { margin-top: 6px; padding: 6px 8px; background: rgba(255,255,255,0.06); border-radius: 8px; }
    canvas { width: 100%; height: 100%; display: block; }
  </style>
  <script src="./js/niivue.umd.js"></script>
</head>
<body>
  <div id="toolbar">
    <h3>Layers</h3>
    <label><input type="checkbox" id="showGT" checked> Show Ground Truth</label>
    <label><input type="checkbox" id="showPred" checked> Show Prediction</label>
    <label>Opacity:
      <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.6">
    </label>
    <hr>
    <div class="section">
      <h3>GT labels</h3>
      <div class="row">
        <label><input type="checkbox" id="gtKidney" checked> 1 · kidney</label>
        <label><input type="checkbox" id="gtTumor"  checked> 2 · tumor</label>
        <label><input type="checkbox" id="gtCyst"   checked> 3 · cyst <span id="gtCystNote" class="hint"></span></label>
      </div>
    </div>
    <div class="section">
      <h3>Pred labels</h3>
      <div class="row">
        <label><input type="checkbox" id="predKidney" checked> 1 · kidney</label>
        <label><input type="checkbox" id="predTumor"  checked> 2 · tumor</label>
        <label><input type="checkbox" id="predCyst"   checked> 3 · cyst <span id="predCystNote" class="hint"></span></label>
      </div>
    </div>
    <div class="hint" style="margin-top:8px;">
      If a label is absent in GT or Pred, its checkbox is disabled for that layer only.
    </div>
  </div>

  <canvas id="gl"></canvas>

<script>
window.addEventListener('load', async () => {
  const NiiVueClass = window.Niivue || (window.niivue && window.niivue.Niivue);
  const NVImageClass = (window.niivue && window.niivue.NVImage) || window.NVImage;
  if (!NiiVueClass) { console.error("Niivue not found."); return; }

  const nv = new NiiVueClass({ show3Dcrosshair: true, isWebGL2: true, logging: true });
  nv.attachTo('gl');

  const base = "./case_00003/";
  const files = [
    { url: base + "imaging_float32_lowres.nii",      name: "Image", colormap: "gray", opacity: 1.0, isSeg: false },
    { url: base + "segmentation_aligned_lowres.nii", name: "GT",    colormap: "gray", opacity: 0.6, isSeg: true  },
    { url: base + "case_00003_aligned_lowres.nii",   name: "Pred",  colormap: "gray", opacity: 0.6, isSeg: true  },
  ];

  async function tryAddViaAddObject(o) {
    if (!nv.addVolumeFromUrl) throw new Error("no-addVolumeFromUrl");
    return await nv.addVolumeFromUrl({ url: o.url, name: o.name, colormap: o.colormap, opacity: o.opacity });
  }
  async function tryAddViaAddString(o) {
    if (!nv.addVolumeFromUrl) throw new Error("no-addVolumeFromUrl");
    return await nv.addVolumeFromUrl(o.url);
  }
  async function tryAddViaNVImageUrl(o) {
    if (!NVImageClass || !NVImageClass.loadFromUrl) throw new Error("no-NVImage-loadFromUrl");
    const img = await NVImageClass.loadFromUrl({ url: o.url, name: o.name });
    nv.addVolume(img);
    return img;
  }
  async function tryAddViaArrayBuffer(o) {
    const hasAB = NVImageClass && NVImageClass.loadFromArrayBuffer;
    if (!hasAB) throw new Error("no-ArrayBuffer-loader");
    const r = await fetch(o.url, { cache: "no-store" });
    if (!r.ok) throw new Error("http-" + r.status);
    const buf = await r.arrayBuffer();
    const img = await NVImageClass.loadFromArrayBuffer({ arrayBuffer: buf, name: o.name });
    nv.addVolume(img);
    return img;
  }

  async function addSmart(o) {
    const errors = [];
    const steps = [tryAddViaAddObject, tryAddViaAddString, tryAddViaNVImageUrl, tryAddViaArrayBuffer];
    for (const fn of steps) {
      try { return await fn(o); } catch (e) { errors.push(e && e.message ? e.message : String(e)); }
    }
    throw new Error("all-loaders-failed: " + errors.join(" | "));
  }

  try {
    for (const f of files) { await addSmart(f); }
    nv.volumes.forEach((v, i) => {
      const meta = files.find(x => x.name === v.name);
      if (meta) {
        v.opacity = meta.opacity;
        if (!meta.isSeg && nv.setColormap) nv.setColormap(v.id, meta.colormap);
      }
    });
    console.log("All volumes loaded.");
  } catch (e) {
    console.error("Failed to load volumes:", e);
    return;
  }

  const idxGT   = nv.volumes.findIndex(v => v.name === "GT");
  const idxPred = nv.volumes.findIndex(v => v.name === "Pred");

  function makeLabelLUT(a1, a2, a3) {
    return {
      R: [0, 0, 255, 255],
      G: [0, 255, 0, 255],
      B: [0, 255, 255, 0],
      A: [0, a1, a2, a3],
      I: [0, 1, 2, 3],
      labels: ["background", "kidney", "tumor", "cyst"]
    };
  }

  function applyLabelLUT(volIndex, a1, a2, a3) {
    if (volIndex < 0 || !nv.volumes[volIndex]) return;
    const lut = makeLabelLUT(a1, a2, a3);
    if (typeof nv.volumes[volIndex].setColormapLabel === "function") {
      nv.volumes[volIndex].setColormapLabel(lut);
    } else {
      nv.volumes[volIndex].colormapLabel = lut;
    }
  }

  applyLabelLUT(idxGT,   160,160,160);
  applyLabelLUT(idxPred, 160,160,160);
  nv.updateGLVolume();

  async function hasLabel(iVol, value) {
    const v = nv.volumes[iVol];
    if (!v) return false;
    const data = v.img || (v.img2RAS && v.img2RAS());
    if (!data) return false;
    for (let k = 0; k < data.length; k++) if (data[k] === value) return true;
    return false;
  }

  const gtCB   = document.getElementById('showGT');
  const predCB = document.getElementById('showPred');
  const opSL   = document.getElementById('opacity');

  function applyLayerUI() {
    const val = parseFloat(opSL.value);
    if (idxGT   >= 0) nv.volumes[idxGT].opacity  = gtCB.checked   ? val : 0.0;
    if (idxPred >= 0) nv.volumes[idxPred].opacity = predCB.checked ? val : 0.0;
    nv.updateGLVolume();
  }
  gtCB.addEventListener('change', applyLayerUI);
  predCB.addEventListener('change', applyLayerUI);
  opSL.addEventListener('input',  applyLayerUI);
  applyLayerUI();

  const gtKidney = document.getElementById('gtKidney');
  const gtTumor  = document.getElementById('gtTumor');
  const gtCyst   = document.getElementById('gtCyst');
  const gtCystNote = document.getElementById('gtCystNote');

  const predKidney = document.getElementById('predKidney');
  const predTumor  = document.getElementById('predTumor');
  const predCyst   = document.getElementById('predCyst');
  const predCystNote = document.getElementById('predCystNote');

  function applyAllLabelVisibility() {
    applyLabelLUT(idxGT,   gtKidney.checked ? 160 : 0, gtTumor.checked ? 160 : 0, gtCyst.checked ? 160 : 0);
    applyLabelLUT(idxPred, predKidney.checked ? 160 : 0, predTumor.checked ? 160 : 0, predCyst.checked ? 160 : 0);
    nv.updateGLVolume();
  }

  gtKidney.addEventListener('change', applyAllLabelVisibility);
  gtTumor .addEventListener('change', applyAllLabelVisibility);
  gtCyst  .addEventListener('change', applyAllLabelVisibility);
  predKidney.addEventListener('change', applyAllLabelVisibility);
  predTumor .addEventListener('change', applyAllLabelVisibility);
  predCyst  .addEventListener('change', applyAllLabelVisibility);

  (async () => {
    if (idxGT >= 0) {
      const exist3 = await hasLabel(idxGT, 3);
      if (!exist3) {
        gtCyst.checked = false;
        gtCyst.disabled = true;
        gtCystNote.textContent = " (no cyst in GT)";
      }
    }
    if (idxPred >= 0) {
      const exist3 = await hasLabel(idxPred, 3);
      if (!exist3) {
        predCyst.checked = false;
        predCyst.disabled = true;
        predCystNote.textContent = " (no cyst in Pred)";
      }
    }
    applyAllLabelVisibility();
  })();
});
</script>
</body>
</html>
