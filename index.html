<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NiiVue Viewer – GT vs Prediction</title>

  <style>
    html, body { margin: 0; height: 100%; background: black; overflow: hidden; }
    #toolbar {
      position: absolute; top: 10px; left: 10px;
      background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px;
      z-index: 10; color: white; font-family: sans-serif; font-size: 14px;
    }
    label { display: block; margin: 6px 0; cursor: pointer; }
    canvas { width: 100%; height: 100%; display: block; }
  </style>

  <!-- 确保此路径正确、文件存在且可被静态服务器访问 -->
  <script src="./js/niivue.umd.js"></script>
</head>

<body>
  <div id="toolbar">
    <strong>Layers</strong>
    <label><input type="checkbox" id="showGT" checked> Show Ground Truth (warm)</label>
    <label><input type="checkbox" id="showPred" checked> Show Prediction (viridis)</label>
    <label>Opacity: <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.6"></label>
  </div>

  <canvas id="gl"></canvas>
<script>
window.addEventListener('load', async () => {
  const NiiVueClass = window.Niivue || (window.niivue && window.niivue.Niivue);
  const nv = new NiiVueClass({ show3Dcrosshair: true, isWebGL2: true, logging: true });
  nv.attachTo('gl');

  const base = "./case_00003/";

  // 明确写上 name 且带扩展名（老版本更稳）
  const vols = [
    { url: base + "imaging_float32_lowres.nii",      name: "imaging_float32_lowres.nii",      colormap: "gray",   opacity: 1.0 },
    { url: base + "segmentation_aligned_lowres.nii", name: "segmentation_aligned_lowres.nii", colormap: "warm",   opacity: 0.6 },
    { url: base + "case_00003_aligned_lowres.nii",   name: "case_00003_aligned_lowres.nii",   colormap: "viridis",opacity: 0.6 },
  ];

  // 预检：任何一项 url 不是字符串都直接抛出
  vols.forEach((v, i) => {
    if (typeof v.url !== 'string' || !v.url.length) {
      throw new TypeError(`volume[${i}] 的 url 非字符串或为空：${v.url}`);
    }
    if (!/\.(nii|nii\.gz|nrrd|mgh|mgz)$/i.test(v.url) && !/\.(nii|nii\.gz|nrrd|mgh|mgz)$/i.test(v.name || '')) {
      console.warn(`volume[${i}] 缺少可识别扩展名（将用 name 兜底）：url=${v.url} name=${v.name}`);
    }
  });

  // 逐个加载以 pinpoint 到具体出错对象
  async function safeAdd(o, idx) {
    try {
      console.log(`Loading [${idx}]`, o);
      await nv.addVolumeFromUrl(o); // 或换成 nv.loadVolumes([o]) 逐个
      console.log(`Loaded [${idx}] OK`);
    } catch (e) {
      console.error(`❌ Failed at volume[${idx}]`, o, e);
      throw e; // 停在第一个坏的
    }
  }

  for (let i = 0; i < vols.length; i++) {
    await safeAdd(vols[i], i);
  }

  // —— UI 同你原来一致 ——
  const gtCB   = document.getElementById('showGT');
  const predCB = document.getElementById('showPred');
  const opSL   = document.getElementById('opacity');

  function applyUI() {
    const val = parseFloat(opSL.value);
    if (nv.volumes[1]) nv.volumes[1].opacity = gtCB.checked   ? val : 0.0;
    if (nv.volumes[2]) nv.volumes[2].opacity = predCB.checked ? val : 0.0;
    nv.updateGLVolume();
  }
  gtCB.addEventListener('change', applyUI);
  predCB.addEventListener('change', applyUI);
  opSL.addEventListener('input', applyUI);
  applyUI();
});
</script>

</body>
</html>
