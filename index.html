<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NiiVue Viewer â€“ GT vs Prediction (warm vs cool)</title>
  <style>
    html, body { margin: 0; height: 100%; background: #000; overflow: hidden; }
    /* Keep the toolbar above the canvas and clickable */
    #toolbar {
      position: fixed; top: 10px; left: 10px; z-index: 9999;
      background: rgba(0,0,0,0.72); color: #fff; font-family: system-ui, sans-serif; font-size: 14px;
      padding: 12px; border-radius: 12px; min-width: 320px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
      pointer-events: auto;
    }
    #toolbar h3 { margin: 0 0 8px; font-size: 15px; }
    #toolbar label { display: block; margin: 6px 0; cursor: pointer; }
    #toolbar hr { border: none; border-top: 1px solid rgba(255,255,255,0.12); margin: 10px 0; }
    .hint { color: #bbb; font-size: 12px; }
    .section { margin-top: 6px; padding: 6px 8px; background: rgba(255,255,255,0.06); border-radius: 8px; }
    /* Ensure canvas sits under the toolbar */
    canvas { width: 100%; height: 100%; display: block; position: relative; z-index: 0; }
  </style>
  <script src="./js/niivue.umd.js"></script>
</head>
<body>
  <div id="toolbar">
    <h3>Layers</h3>
    <label><input type="checkbox" id="showGT" checked> Show Ground Truth (warm)</label>
    <label><input type="checkbox" id="showPred" checked> Show Prediction (cool)</label>
    <label>Mask opacity:
      <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.6">
    </label>
    <hr>
    <div class="section">
      <h3>Notes</h3>
      <div class="hint">GT uses warm colormap; Pred uses cool colormap. Use the toggles above to show/hide entire layers.</div>
    </div>
  </div>

  <canvas id="gl"></canvas>

<script>
window.addEventListener('load', async () => {
  const NiiVueClass = window.Niivue || (window.niivue && window.niivue.Niivue);
  if (!NiiVueClass) { console.error("Niivue not found."); return; }

  const nv = new NiiVueClass({ show3Dcrosshair: true, isWebGL2: true, logging: true });
  nv.attachTo('gl');

  function absUrl(p) { return new URL(p, window.location.href).toString(); }

  let base = "./case_00003/";
  if (!base.endsWith("/")) base += "/";

  const urlImg  = absUrl(base + "imaging_float32_lowres.nii");
  const urlGT   = absUrl(base + "segmentation_aligned_lowres.nii");
  const urlPred = absUrl(base + "case_00003_aligned_lowres.nii");
  console.log("Resolved URLs:", { urlImg, urlGT, urlPred });

  try {
    // Only pass an object with a non-empty url field (matches your working build)
    await nv.addVolumeFromUrl({ url: urlImg  });
    await nv.addVolumeFromUrl({ url: urlGT   });
    await nv.addVolumeFromUrl({ url: urlPred });

    // Post-config: names, opacity, and distinct colormaps
    let img  = nv.volumes[0]; if (img)  { img.name  = "Image"; img.opacity = 1.0; if (nv.setColormap) nv.setColormap(img.id,  "gray"); }
    let gt   = nv.volumes[1]; if (gt)   { gt.name   = "GT";    gt.opacity  = 0.6; if (nv.setColormap) nv.setColormap(gt.id,   "warm"); }
    let pred = nv.volumes[2]; if (pred) { pred.name = "Pred";  pred.opacity= 0.6; if (nv.setColormap) nv.setColormap(pred.id, "cool"); }

    console.log("All volumes loaded.");
  } catch (e) {
    console.error("Failed to load volumes:", e);
    return;
  }

  const idxGT   = nv.volumes.findIndex(v => v.name === "GT");
  const idxPred = nv.volumes.findIndex(v => v.name === "Pred");

  const gtCB   = document.getElementById('showGT');
  const predCB = document.getElementById('showPred');
  const opSL   = document.getElementById('opacity');

  function applyUI() {
    const val = parseFloat(opSL.value);
    if (idxGT   >= 0) nv.volumes[idxGT].opacity  = gtCB.checked   ? val : 0.0;
    if (idxPred >= 0) nv.volumes[idxPred].opacity = predCB.checked ? val : 0.0;
    nv.updateGLVolume();
  }

  gtCB.addEventListener('change', applyUI);
  predCB.addEventListener('change', applyUI);
  opSL.addEventListener('input',  applyUI);
  applyUI();
});
</script>
</body>
</html>
