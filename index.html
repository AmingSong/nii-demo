<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NiiVue Viewer – GT vs Prediction</title>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: black;
      overflow: hidden;
    }
    #toolbar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 10px;
      z-index: 10;
      color: white;
      font-family: sans-serif;
    }
    label { display: block; margin: 6px 0; cursor: pointer; }
    canvas { width: 100%; height: 100%; display: block; }
    .small { color:#bbb; font-size:12px; }
  </style>

  <script src="./js/niivue.umd.js"></script>
</head>

<body>
  <div id="toolbar">
    <strong>Layers</strong>
    <label><input type="checkbox" id="showGT" checked> Show Ground Truth (Red)</label>
    <label><input type="checkbox" id="showPred" checked> Show Prediction (Green)</label>
    <label>Opacity: <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.6"></label>

    <hr>
    <strong>GT labels</strong>
    <label><input type="checkbox" id="gtKidney" checked> 1 · kidney</label>
    <label><input type="checkbox" id="gtTumor"  checked> 2 · tumor</label>
    <label><input type="checkbox" id="gtCyst"   checked> 3 · cyst <span id="gtCystNote" class="small"></span></label>

    <hr>
    <strong>Pred labels</strong>
    <label><input type="checkbox" id="predKidney" checked> 1 · kidney</label>
    <label><input type="checkbox" id="predTumor"  checked> 2 · tumor</label>
    <label><input type="checkbox" id="predCyst"   checked> 3 · cyst <span id="predCystNote" class="small"></span></label>
    <div class="small" style="margin-top:6px;">If a label is absent in GT/Pred, its checkbox will be disabled for that layer only.</div>
  </div>

  <canvas id="gl"></canvas>

<script>
window.addEventListener('load', async () => {
  const NiiVueClass = window.Niivue || (window.niivue && window.niivue.Niivue);
  if (!NiiVueClass) {
    console.error("Niivue not found in window scope.");
    return;
  }

  const nv = new NiiVueClass({
    show3Dcrosshair: true,
    isWebGL2: true,
    logging: true,
  });
  nv.attachTo('gl');

  const base = "./case_00003/";

  // === keep your original loading EXACTLY as-is ===
  await nv.addVolumeFromUrl({
    url: base + "imaging_float32_lowres.nii",
    name: "Image",
    colormap: "gray",
    opacity: 1.0
  });

  await nv.addVolumeFromUrl({
    url: base + "segmentation_aligned_lowres.nii",
    name: "GT",
    colormap: "gray",
    opacity: 0.6
  });

  await nv.addVolumeFromUrl({
    url: base + "case_00003_aligned_lowres.nii",
    name: "Pred",
    colormap: "gray",
    opacity: 0.6
  });

  console.log("All volumes loaded.");

  const gtCB   = document.getElementById('showGT');
  const predCB = document.getElementById('showPred');
  const opSL   = document.getElementById('opacity');

  function applyUI() {
    const val = parseFloat(opSL.value);
    if (nv.volumes[1]) nv.volumes[1].opacity = gtCB.checked   ? val : 0.0;
    if (nv.volumes[2]) nv.volumes[2].opacity = predCB.checked ? val : 0.0;
    nv.updateGLVolume();
  }

  gtCB.addEventListener('change', applyUI);
  predCB.addEventListener('change', applyUI);
  opSL.addEventListener('input', applyUI);
  applyUI();

  // === add discrete label coloring and per-layer toggles (post-load only) ===
  const idxGT   = nv.volumes.findIndex(v => v.name === "GT");
  const idxPred = nv.volumes.findIndex(v => v.name === "Pred");

  function makeLabelLUT(a1, a2, a3) {
    return {
      R: [0, 0, 255, 255],
      G: [0, 255, 0, 255],
      B: [0, 255, 255, 0],
      A: [0, a1, a2, a3],
      I: [0, 1, 2, 3],
      labels: ["background", "kidney", "tumor", "cyst"]
    };
  }

  function applyLabelLUT(volIndex, a1, a2, a3) {
    if (volIndex < 0 || !nv.volumes[volIndex]) return;
    const lut = makeLabelLUT(a1, a2, a3);
    if (typeof nv.volumes[volIndex].setColormapLabel === "function") {
      nv.volumes[volIndex].setColormapLabel(lut);
    } else {
      nv.volumes[volIndex].colormapLabel = lut;
    }
  }

  applyLabelLUT(idxGT,   160,160,160);
  applyLabelLUT(idxPred, 160,160,160);
  nv.updateGLVolume();

  async function hasLabel(iVol, value) {
    const v = nv.volumes[iVol];
    if (!v) return false;
    const data = v.img || (v.img2RAS && v.img2RAS());
    if (!data) return false;
    for (let k = 0; k < data.length; k++) if (data[k] === value) return true;
    return false;
  }

  const gtKidney = document.getElementById('gtKidney');
  const gtTumor  = document.getElementById('gtTumor');
  const gtCyst   = document.getElementById('gtCyst');
  const gtCystNote = document.getElementById('gtCystNote');

  const predKidney = document.getElementById('predKidney');
  const predTumor  = document.getElementById('predTumor');
  const predCyst   = document.getElementById('predCyst');
  const predCystNote = document.getElementById('predCystNote');

  function applyOne(volIndex, kOn, tOn, cOn) {
    applyLabelLUT(volIndex, kOn ? 160 : 0, tOn ? 160 : 0, cOn ? 160 : 0);
  }
  function applyAll() {
    applyOne(idxGT,   gtKidney.checked,  gtTumor.checked,  gtCyst.checked);
    applyOne(idxPred, predKidney.checked, predTumor.checked, predCyst.checked);
    nv.updateGLVolume();
  }

  gtKidney.addEventListener('change', applyAll);
  gtTumor .addEventListener('change', applyAll);
  gtCyst  .addEventListener('change', applyAll);
  predKidney.addEventListener('change', applyAll);
  predTumor .addEventListener('change', applyAll);
  predCyst  .addEventListener('change', applyAll);

  (async () => {
    if (idxGT >= 0) {
      const exist3 = await hasLabel(idxGT, 3);
      if (!exist3) {
        gtCyst.checked = false;
        gtCyst.disabled = true;
        gtCystNote.textContent = " (no cyst in GT)";
      }
    }
    if (idxPred >= 0) {
      const exist3 = await hasLabel(idxPred, 3);
      if (!exist3) {
        predCyst.checked = false;
        predCyst.disabled = true;
        predCystNote.textContent = " (no cyst in Pred)";
      }
    }
    applyAll();
  })();
});
</script>

</body>
</html>
