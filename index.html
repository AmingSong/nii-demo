<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NiiVue Viewer – GT vs Prediction (Stable Label Control)</title>
  <style>
    html, body { margin: 0; height: 100%; background: #000; overflow: hidden; }
    #toolbar {
      position: fixed; top: 10px; left: 10px; z-index: 9999;
      background: rgba(0,0,0,0.72); color: #fff; font-family: system-ui, sans-serif; font-size: 14px;
      padding: 12px; border-radius: 12px; min-width: 360px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }
    #toolbar h3 { margin: 0 0 8px; font-size: 15px; }
    #toolbar label { display: block; margin: 6px 0; cursor: pointer; }
    #toolbar hr { border: none; border-top: 1px solid rgba(255,255,255,0.12); margin: 10px 0; }
    .hint { color: #bbb; font-size: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 16px; }
    .section { margin-top: 6px; padding: 6px 8px; background: rgba(255,255,255,0.06); border-radius: 8px; }
    canvas { width: 100%; height: 100%; display: block; }
  </style>
  <script src="./js/niivue.umd.js"></script>
</head>
<body>
  <div id="toolbar">
    <h3>Layers</h3>
    <label><input type="checkbox" id="showGT" checked> Show Ground Truth (warm)</label>
    <label><input type="checkbox" id="showPred" checked> Show Prediction (cool)</label>
    <label>Mask opacity:
      <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.6">
    </label>
    <hr>
    <div class="section">
      <h3>GT labels (warm)</h3>
      <div class="row">
        <label><input type="checkbox" id="gtKidney" checked> 1 · kidney</label>
        <label><input type="checkbox" id="gtTumor"  checked> 2 · tumor</label>
        <label><input type="checkbox" id="gtCyst"   checked> 3 · cyst <span id="gtCystNote" class="hint"></span></label>
      </div>
    </div>
    <div class="section">
      <h3>Pred labels (cool)</h3>
      <div class="row">
        <label><input type="checkbox" id="predKidney" checked> 1 · kidney</label>
        <label><input type="checkbox" id="predTumor"  checked> 2 · tumor</label>
        <label><input type="checkbox" id="predCyst"   checked> 3 · cyst <span id="predCystNote" class="hint"></span></label>
      </div>
    </div>
  </div>

  <canvas id="gl"></canvas>

<script>
window.addEventListener('load', async () => {
  const NiiVueClass = window.Niivue || (window.niivue && window.niivue.Niivue);
  if (!NiiVueClass) { console.error("Niivue not found."); return; }

  const nv = new NiiVueClass({ show3Dcrosshair: true, isWebGL2: true, logging: true });
  nv.attachTo('gl');

  const base = "./case_00003/";

  const vols = [
    { url: base + "imaging_float32_lowres.nii", name: "Image", colormap: "gray", opacity: 1.0 },
    { url: base + "segmentation_labels_int.nii", name: "GT", colormap: "warm", opacity: 0.6 },
    { url: base + "pred_labels_int.nii", name: "Pred", colormap: "cool", opacity: 0.6 }
  ];

  try {
    for (const v of vols) {
      if (!v.colormap) v.colormap = "gray";
      console.log("Loading:", v.url);
      await nv.addVolumeFromUrl(v);
    }
    console.log("All volumes loaded");
  } catch (e) {
    console.error("Failed to load volumes:", e);
    return;
  }

  const idxGT = 1, idxPred = 2;
  const ON = 255, OFF = 0;

  function makeLUT(r, g, b, a) {
    return { R:r, G:g, B:b, A:a, I:[0,1,2,3] };
  }

  const warmLUT = (a1,a2,a3)=>makeLUT([0,255,255,255],[0,140,60,200],[0,0,60,0],[0,a1,a2,a3]);
  const coolLUT = (a1,a2,a3)=>makeLUT([0,0,0,160],[0,200,120,0],[0,255,255,255],[0,a1,a2,a3]);

  function applyLabelLUT(volIdx, lut) {
    const v = nv.volumes[volIdx];
    if (!v) return;
    v.colormapLabel = lut;
    nv.updateGLVolume();
  }

  function updateLabels() {
    applyLabelLUT(idxGT,   warmLUT(
      gtKidney.checked ? ON : OFF,
      gtTumor.checked ? ON : OFF,
      gtCyst.checked ? ON : OFF
    ));
    applyLabelLUT(idxPred, coolLUT(
      predKidney.checked ? ON : OFF,
      predTumor.checked ? ON : OFF,
      predCyst.checked ? ON : OFF
    ));
  }

  const gtKidney = document.getElementById('gtKidney');
  const gtTumor = document.getElementById('gtTumor');
  const gtCyst = document.getElementById('gtCyst');
  const predKidney = document.getElementById('predKidney');
  const predTumor = document.getElementById('predTumor');
  const predCyst = document.getElementById('predCyst');

  [gtKidney, gtTumor, gtCyst, predKidney, predTumor, predCyst].forEach(cb => {
    cb.addEventListener('change', updateLabels);
  });

  updateLabels();

  const gtCB = document.getElementById('showGT');
  const predCB = document.getElementById('showPred');
  const opSL = document.getElementById('opacity');
  function applyLayerUI() {
    const val = parseFloat(opSL.value);
    nv.volumes[idxGT].opacity = gtCB.checked ? val : 0.0;
    nv.volumes[idxPred].opacity = predCB.checked ? val : 0.0;
    nv.updateGLVolume();
  }
  gtCB.addEventListener('change', applyLayerUI);
  predCB.addEventListener('change', applyLayerUI);
  opSL.addEventListener('input', applyLayerUI);
  applyLayerUI();
});
</script>
</body>
</html>
