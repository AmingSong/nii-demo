<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NiiVue Viewer – GT (warm labels) vs Pred (cool labels)</title>
  <style>
    html, body { margin: 0; height: 100%; background: #000; overflow: hidden; }
    #toolbar {
      position: fixed; top: 10px; left: 10px; z-index: 9999;
      background: rgba(0,0,0,0.72); color: #fff; font-family: system-ui, sans-serif; font-size: 14px;
      padding: 12px; border-radius: 12px; min-width: 360px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
      pointer-events: auto;
    }
    #toolbar h3 { margin: 0 0 8px; font-size: 15px; }
    #toolbar label { display: block; margin: 6px 0; cursor: pointer; }
    #toolbar hr { border: none; border-top: 1px solid rgba(255,255,255,0.12); margin: 10px 0; }
    .hint { color: #bbb; font-size: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 16px; }
    .section { margin-top: 6px; padding: 6px 8px; background: rgba(255,255,255,0.06); border-radius: 8px; }
    canvas { width: 100%; height: 100%; display: block; position: relative; z-index: 0; }
  </style>
  <script src="./js/niivue.umd.js"></script>
</head>
<body>
  <div id="toolbar">
    <h3>Layers</h3>
    <label><input type="checkbox" id="showGT" checked> Show Ground Truth (warm)</label>
    <label><input type="checkbox" id="showPred" checked> Show Prediction (cool)</label>
    <label>Mask opacity:
      <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.6">
    </label>

    <hr>
    <div class="section">
      <h3>GT labels (warm)</h3>
      <div class="row">
        <label><input type="checkbox" id="gtKidney" checked> 1 · kidney</label>
        <label><input type="checkbox" id="gtTumor"  checked> 2 · tumor</label>
        <label><input type="checkbox" id="gtCyst"   checked> 3 · cyst <span id="gtCystNote" class="hint"></span></label>
      </div>
    </div>

    <div class="section">
      <h3>Pred labels (cool)</h3>
      <div class="row">
        <label><input type="checkbox" id="predKidney" checked> 1 · kidney</label>
        <label><input type="checkbox" id="predTumor"  checked> 2 · tumor</label>
        <label><input type="checkbox" id="predCyst"   checked> 3 · cyst <span id="predCystNote" class="hint"></span></label>
      </div>
    </div>

    <div class="hint" style="margin-top:8px;">
      Layer toggles control whole masks; per-label checkboxes toggle labels 1/2/3 via LUT alpha.
    </div>
  </div>

  <canvas id="gl"></canvas>

<script>
window.addEventListener('load', async () => {
  const NiiVueClass = window.Niivue || (window.niivue && window.niivue.Niivue);
  if (!NiiVueClass) { console.error("Niivue not found."); return; }

  const nv = new NiiVueClass({ show3Dcrosshair: true, isWebGL2: true, logging: true });
  nv.attachTo('gl');

  function absUrl(p) { return new URL(p, window.location.href).toString(); }
  function fileNameFromUrl(u) {
    try { const s = u.split('?')[0]; return s.substring(s.lastIndexOf('/')+1) || u; }
    catch { return u; }
  }

  let base = "./case_00003/";
  if (!base.endsWith("/")) base += "/";
  const bust = `?v=${Date.now()}`;

  const urlImg  = absUrl(base + "imaging_float32_lowres.nii" + bust);
  const urlGT   = absUrl(base + "segmentation_labels_int.nii" + bust);
  const urlPred = absUrl(base + "pred_labels_int.nii" + bust);
  console.log("Resolved URLs:", { urlImg, urlGT, urlPred });

  async function preflight(url) {
    const res = await fetch(url, {
      method: 'GET',
      headers: { 'Range': 'bytes=0-127' },
      cache: 'no-store'
    });
    if (!res.ok && res.status !== 206) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const ct = (res.headers.get('Content-Type') || '').toLowerCase();
    const buf = await res.arrayBuffer();
    const txtHead = new TextDecoder().decode(new Uint8Array(buf));
    if (ct.includes('text/html')) throw new Error('Got HTML instead of NIfTI');
    if (txtHead.startsWith('version https://git-lfs.github.com/spec')) {
      throw new Error('Got Git LFS pointer text instead of NIfTI');
    }
    return true;
  }

  async function addVolumeSafe({url, name, colormap, opacity}) {
    if (typeof url !== 'string' || !url) throw new Error('volume url must be non-empty string');
    const nm = name || fileNameFromUrl(url);
    const op = typeof opacity === 'number' ? opacity : 1.0;
    await preflight(url);
    // 对于 GT/Pred 不要传 colormap（避免走连续体积路径）
    const o = { url, name: nm, opacity: op };
    if (colormap) o.colormap = colormap; // 仅给底层图像传 gray
    return nv.addVolumeFromUrl(o);
  }

  try {
    // 背景图像仍然是连续体积，用 gray
    await addVolumeSafe({ url: urlImg,  name: 'imaging_float32_lowres.nii',  colormap: 'gray', opacity: 1.0 });
    // GT/Pred 不传 colormap（关键）
    await addVolumeSafe({ url: urlGT,   name: 'segmentation_labels_int.nii', opacity: 0.6 });
    await addVolumeSafe({ url: urlPred, name: 'pred_labels_int.nii',         opacity: 0.6 });
    console.log("All volumes loaded.");
  } catch (e) {
    console.error("Failed to load volumes:", e);
    return;
  }

  const idxGT   = nv.volumes.findIndex(v => v.name === "segmentation_labels_int.nii" || v.name === "GT");
  const idxPred = nv.volumes.findIndex(v => v.name === "pred_labels_int.nii"         || v.name === "Pred");

  function warmLUT(a1, a2, a3) {
    return {
      R: [0, 255, 255, 255],
      G: [0, 140,  60, 200],
      B: [0,   0,  60,   0],
      A: [0,  a1,  a2,  a3],
      I: [0,   1,   2,   3],
      labels: ["background", "kidney", "tumor", "cyst"]
    };
  }
  function coolLUT(a1, a2, a3) {
    return {
      R: [0,   0,   0, 160],
      G: [0, 200, 120,   0],
      B: [0, 255, 255, 255],
      A: [0,  a1,  a2,  a3],
      I: [0,   1,   2,   3],
      labels: ["background", "kidney", "tumor", "cyst"]
    };
  }

  function refreshColorStuff() {
    if (typeof nv.refreshColormaps === "function") nv.refreshColormaps();
    else if (typeof nv.refreshLayers === "function") nv.refreshLayers();
  }
function applyLabelLUT(volIndex, palette, a1, a2, a3) {
  const vol = nv.volumes[volIndex];
  if (!vol) return;

  const lut = (palette === "warm")
    ? {
        R: [0, 255, 255, 255],
        G: [0, 140,  60, 200],
        B: [0,   0,  60,   0],
        A: [0,  a1,  a2,  a3],
        I: [0,   1,   2,   3],
        labels: ["background", "kidney", "tumor", "cyst"]
      }
    : {
        R: [0,   0,   0, 160],
        G: [0, 200, 120,   0],
        B: [0, 255, 255, 255],
        A: [0,  a1,  a2,  a3],
        I: [0,   1,   2,   3],
        labels: ["background", "kidney", "tumor", "cyst"]
      };

  // 1) 进入标签渲染模式
  vol.isLabel = true;

  // 2) 设置一个非空的 colormap 字符串，避免内部 toLowerCase 报错
  vol.colormap = (palette === "warm") ? "warm" : "cool";

  // 3) 设置 label LUT（真正控制 1/2/3 的透明度）
  if (typeof nv.setColormapLabel === "function") {
    nv.setColormapLabel(vol.id, lut);
  } else {
    vol.colormapLabel = lut;
    vol.colorMapLabel = lut;
  }

  // 4) 刷新并重绘
  if (typeof nv.refreshLayers === "function") nv.refreshLayers();
  else if (typeof nv.refreshColormaps === "function") nv.refreshColormaps();
  nv.updateGLVolume();
}

  function applyLayerUI() {
    const val = parseFloat(opSL.value);
    if (idxGT   >= 0) nv.volumes[idxGT].opacity  = gtCB.checked   ? val : 0.0;
    if (idxPred >= 0) nv.volumes[idxPred].opacity = predCB.checked ? val : 0.0;
    nv.updateGLVolume();
  }
  gtCB.addEventListener('change', applyLayerUI);
  predCB.addEventListener('change', applyLayerUI);
  opSL.addEventListener('input',  applyLayerUI);
  applyLayerUI();

  const gtKidney = document.getElementById('gtKidney');
  const gtTumor  = document.getElementById('gtTumor');
  const gtCyst   = document.getElementById('gtCyst');
  const gtCystNote = document.getElementById('gtCystNote');
  const predKidney = document.getElementById('predKidney');
  const predTumor  = document.getElementById('predTumor');
  const predCyst   = document.getElementById('predCyst');
  const predCystNote = document.getElementById('predCystNote');

  function applyAllLabelVisibility() {
    applyLabelLUT(idxGT, "warm",
      gtKidney.checked ? ON : OFF,
      gtTumor.checked  ? ON : OFF,
      gtCyst.checked   ? ON : OFF
    );
    applyLabelLUT(idxPred, "cool",
      predKidney.checked ? ON : OFF,
      predTumor.checked  ? ON : OFF,
      predCyst.checked   ? ON : OFF
    );
  }

  gtKidney.addEventListener('change', applyAllLabelVisibility);
  gtTumor .addEventListener('change', applyAllLabelVisibility);
  gtCyst  .addEventListener('change', applyAllLabelVisibility);
  predKidney.addEventListener('change', applyAllLabelVisibility);
  predTumor .addEventListener('change', applyAllLabelVisibility);
  predCyst  .addEventListener('change', applyAllLabelVisibility);

  async function hasLabel(iVol, value) {
    const v = nv.volumes[iVol];
    if (!v) return false;
    const data = v.img || (typeof v.img2RAS === "function" ? v.img2RAS() : null);
    if (!data || !data.length) return false;
    for (let k = 0; k < data.length; k++) if (data[k] === value) return true;
    return false;
  }

  (async () => {
    if (idxGT >= 0) {
      const exist3 = await hasLabel(idxGT, 3);
      if (!exist3) { gtCyst.checked = false; gtCyst.disabled = true; gtCystNote.textContent = " (no cyst in GT)"; }
    }
    if (idxPred >= 0) {
      const exist3 = await hasLabel(idxPred, 3);
      if (!exist3) { predCyst.checked = false; predCyst.disabled = true; predCystNote.textContent = " (no cyst in Pred)"; }
    }
    applyAllLabelVisibility();
  })();
});
</script>
</body>
</html>
